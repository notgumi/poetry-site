name: Build poems

on:
  push:
    paths:
      - 'raw_poems/**.txt'
      - 'data/posts/**.json'
      - 'convert.js'
      - 'update_index.js'
      - '.github/workflows/convert.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-node@v4
        with: { node-version: '20' }

      - name: Detect changed raw txt
        id: diff
        shell: bash
        run: |
          BASE="${{ github.event.before }}"
          if [ -z "$BASE" ] || [ "$BASE" = "0000000000000000000000000000000000000000" ]; then
            BASE="$(git rev-parse HEAD~1 || echo "")"
          fi
          if [ -n "$BASE" ]; then
            TXT=$(git diff --name-only "$BASE" ${{ github.sha }} | grep '^raw_poems/.*\.txt$' || true)
          else
            TXT=$(git show --name-only --pretty="" ${{ github.sha }} | grep '^raw_poems/.*\.txt$' || true)
          fi
          echo "txt=$TXT" >> $GITHUB_OUTPUT
          echo "Changed txt:"
          echo "$TXT"

      - name: Run convert.js
        run: |
          if [ -n "${{ steps.diff.outputs.txt }}" ]; then
            echo "Convert changed txt only..."
            node convert.js ${{ steps.diff.outputs.txt }}
          else
            echo "No changed txt; convert.js will self-check by mtime."
            node convert.js
          fi

      - name: Rebuild index (sorted by date desc)
        run: node update_index.js

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update posts & index"
          file_pattern: |
            data/posts/**
            data/index.json
